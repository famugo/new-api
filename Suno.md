# Suno API文档

**简介**:Suno API文档

## 接口列表
支持的接口如下：
+ [x] /suno/submit/music
+ [x] /suno/submit/lyrics
+ [x] /suno/fetch
+ [x] /suno/fetch/:id

## 模型列表

### Suno API支持

- suno_music (自定义模式、灵感模式、续写)
- suno_lyrics (生成歌词)


## 模型价格设置（在设置-运营设置-模型固定价格设置中设置）
```json
{
  "suno_music": 0.3,
  "suno_lyrics": 0.01
}
```

## 渠道设置

### 对接 Suno API

1.
部署 Suno API，并配置好suno账号等（强烈建议设置密钥），[项目地址](https://github.com/Suno-API/Suno-API)

2. 在渠道管理中添加渠道，渠道类型选择**Suno API**
   ，模型请参考上方模型列表
3. **代理**填写 Suno API 部署的地址，例如：http://localhost:8080
4. 密钥填写 Suno API 的密钥，如果没有设置密钥，可以随便填

### 对接上游new api

1. 在渠道管理中添加渠道，渠道类型选择**Suno API**，或任意类型，只需模型包含上方模型列表的模型
2. **代理**填写上游new api的地址，例如：http://localhost:3000
3. 密钥填写上游new api的密钥

# 项目架构与实现细节

## 系统架构

New API 是一个新一代API网关和AI资产管理系统，采用模块化的架构设计，主要包括以下核心组件：

1. **主程序入口**：`main.go` 负责初始化服务器、数据库连接、中间件和路由。

2. **路由管理**：
   - `router/main.go`：设置主路由
   - `router/api-router.go`：定义API路由
   - `router/relay-router.go`：设置中继功能路由
   - `router/dashboard-router.go`：管理仪表盘路由

3. **数据模型**：
   - `model/main.go`：初始化数据库连接
   - `model/user.go`：用户模型
   - `model/channel.go`：渠道模型
   - `model/token.go`：令牌模型
   - `model/cache.go`：缓存实现

4. **控制器**：
   - `controller/user.go`：用户管理
   - `controller/channel.go`：渠道管理
   - `controller/relay.go`：中继请求处理

5. **中间件**：
   - `middleware/auth.go`：认证中间件
   - `middleware/distributor.go`：分发中间件

6. **中继功能**：
   - `relay/relay-text.go`：文本中继
   - `relay/relay-image.go`：图像生成中继
   - `relay/relay-mj.go`：Midjourney中继
   - `relay/websocket.go`：WebSocket实现

7. **前端实现**：
   - React框架构建的管理界面
   - 组件化设计的用户界面

## 核心功能实现

### 1. 认证与授权

系统实现了多层次的认证与授权机制：

- **会话认证**：通过`sessions`包管理用户会话
- **令牌认证**：支持Bearer令牌和API密钥认证
- **IP白名单**：可为令牌设置IP访问限制
- **模型访问控制**：可限制令牌能够访问的模型

认证流程：
1. 检查请求头中的授权信息
2. 验证令牌有效性
3. 检查用户状态和权限
4. 设置上下文信息供后续中间件使用

### 2. 渠道管理与负载均衡

系统支持多渠道管理和智能负载均衡：

- **渠道分组**：通过组标签对渠道进行分类
- **优先级和权重**：基于优先级和权重进行渠道选择
- **模型映射**：支持模型名称的映射转换
- **自动重试**：渠道失败时自动重试其他渠道

渠道选择算法：
1. 根据用户组和请求模型筛选可用渠道
2. 按优先级排序渠道
3. 在相同优先级的渠道中按权重随机选择

### 3. 中继请求处理

系统支持多种类型的中继请求处理：

- **文本中继**：处理聊天和文本生成请求
- **图像生成**：支持DALL-E等图像生成模型
- **Midjourney集成**：支持Midjourney的图像生成和操作
- **WebSocket通信**：支持实时流式响应

中继处理流程：
1. 解析和验证请求
2. 预消费配额
3. 选择适当的适配器处理请求
4. 转发请求到上游服务
5. 处理响应并返回给客户端
6. 计算实际消费配额并更新用户账户

### 4. 配额管理

系统实现了精确的配额管理机制：

- **预消费机制**：请求前预先扣除配额
- **实际消费计算**：根据实际使用情况计算配额
- **分组倍率**：不同用户组可设置不同的配额倍率
- **模型定价**：支持为不同模型设置不同价格

### 5. 缓存实现

系统使用多层缓存提高性能：

- **内存缓存**：缓存渠道、用户和令牌信息
- **Redis缓存**：可选的分布式缓存支持
- **定期同步**：定期从数据库同步缓存数据

### 6. 前端实现

前端使用React框架，主要功能包括：

- **用户管理**：注册、登录、个人设置
- **渠道管理**：添加、编辑、删除渠道
- **令牌管理**：创建和管理API令牌
- **聊天界面**：通过iframe集成第三方聊天界面
- **系统监控**：查看使用统计和系统状态

## 数据库设计

系统支持多种数据库后端（SQLite、MySQL、PostgreSQL），核心数据模型包括：

1. **用户模型**：
   - 基本信息：用户名、密码、邮箱
   - 权限控制：角色、状态
   - 配额管理：剩余配额、已用配额

2. **渠道模型**：
   - 基本信息：名称、类型、密钥
   - 配置信息：基础URL、模型映射
   - 负载均衡：优先级、权重、分组

3. **令牌模型**：
   - 基本信息：密钥、名称、用户ID
   - 使用限制：过期时间、IP限制、模型限制
   - 配额管理：剩余配额、无限配额标志

## 数据库表及其项目中的作用

系统使用多个数据库表来支持各种功能，每个表在项目中扮演着特定的角色：

### 1. User（用户表）
- **核心作用**：用户身份和权限管理的基础
- **在项目中的功能**：
  - 存储用户认证信息，支持多种登录方式（密码、GitHub、微信等）
  - 管理用户权限级别（普通用户、管理员、超级管理员）
  - 跟踪用户配额使用情况，支持计费和限额
  - 存储用户个性化设置和分组信息
  - 支持用户状态管理（启用/禁用）
  - 管理邀请关系和推广系统
- **关键字段**：
  - `Id`：用户唯一标识
  - `Username/Password`：基本认证信息
  - `Role/Status`：权限和状态控制
  - `Quota/UsedQuota`：配额管理
  - `Group`：用户分组，用于渠道选择和价格策略
  - `AccessToken`：系统管理访问令牌

### 2. Channel（渠道表）
- **核心作用**：AI服务提供商连接管理
- **在项目中的功能**：
  - 存储各AI服务提供商的API密钥和配置
  - 实现智能负载均衡和故障转移
  - 支持不同模型和服务类型的映射
  - 提供渠道健康监控和自动禁用机制
  - 管理渠道的优先级和权重
  - 按分组隔离渠道资源
- **关键字段**：
  - `Id/Type/Key`：渠道基本信息
  - `Status/ResponseTime`：健康状态监控
  - `BaseURL`：API服务地址
  - `Weight/Priority`：负载均衡参数
  - `Models/ModelMapping`：支持的模型和映射
  - `Group`：渠道分组
  - `Balance/UsedQuota`：资源使用跟踪

### 3. Token（令牌表）
- **核心作用**：API访问控制和鉴权
- **在项目中的功能**：
  - 提供API访问的身份验证
  - 实现细粒度的访问控制（模型限制、IP限制）
  - 管理令牌的配额和使用限制
  - 支持令牌过期和访问时间跟踪
  - 允许用户创建和管理多个API密钥
- **关键字段**：
  - `Key`：API访问密钥
  - `UserId`：关联的用户
  - `Status/ExpiredTime`：令牌状态控制
  - `RemainQuota/UnlimitedQuota`：配额管理
  - `ModelLimits`：模型访问限制
  - `AllowIps`：IP白名单
  - `Group`：令牌分组

### 4. Option（选项表）
- **核心作用**：系统全局配置存储
- **在项目中的功能**：
  - 存储系统级别的配置参数
  - 管理功能开关和系统行为
  - 支持动态修改系统设置而无需重启
  - 存储模型价格和分组倍率配置
  - 管理第三方集成设置（邮件、OAuth等）
- **关键字段**：
  - `Key`：配置项名称
  - `Value`：配置值

### 5. Redemption（兑换码表）
- **核心作用**：管理配额充值和促销活动
- **在项目中的功能**：
  - 支持预生成兑换码系统
  - 实现配额充值和礼品卡功能
  - 跟踪兑换码使用状态和历史
  - 支持营销和用户激励计划
- **关键字段**：
  - `Id/Key`：兑换码标识
  - `Value`：兑换码价值（配额）
  - `Status`：使用状态
  - `UserId`：使用者ID

### 6. Ability（能力表）
- **核心作用**：定义和管理模型能力
- **在项目中的功能**：
  - 记录不同AI模型的能力和特性
  - 支持模型功能的动态发现
  - 管理模型与渠道的兼容性
  - 提供能力查询接口
- **关键字段**：
  - `Id/Name`：能力标识
  - `Description`：能力描述
  - `Models`：支持该能力的模型列表

### 7. Log（日志表）
- **核心作用**：系统操作和API调用记录
- **在项目中的功能**：
  - 记录API请求和响应详情
  - 跟踪配额消耗和计费信息
  - 支持审计和问题排查
  - 提供使用统计和分析数据
  - 记录系统错误和异常情况
- **关键字段**：
  - `Id/UserId/TokenId`：关联信息
  - `Type/Status`：日志类型和状态
  - `RequestBody/ResponseBody`：请求和响应内容
  - `Quota`：消耗的配额
  - `CreatedAt`：创建时间

### 8. Midjourney（Midjourney任务表）
- **核心作用**：Midjourney图像生成任务管理
- **在项目中的功能**：
  - 存储Midjourney特定的任务信息
  - 跟踪图像生成任务的状态和进度
  - 管理任务队列和结果
  - 支持任务重试和操作（放大、变体等）
- **关键字段**：
  - `Id/Action`：任务标识和操作类型
  - `Status/Progress`：任务状态和进度
  - `PromptEn`：英文提示词
  - `ImageUrl`：生成的图像URL
  - `UserId/ChannelId`：关联信息

### 9. TopUp（充值表）
- **核心作用**：用户充值记录管理
- **在项目中的功能**：
  - 记录用户充值交易
  - 支持多种支付方式和充值渠道
  - 提供充值历史和财务报表
  - 管理充值状态和处理流程
- **关键字段**：
  - `Id/UserId`：交易和用户标识
  - `Amount/Status`：充值金额和状态
  - `Type/Channel`：充值类型和渠道
  - `CreatedAt/UpdatedAt`：时间戳

### 10. QuotaData（配额数据表）
- **核心作用**：详细配额使用记录
- **在项目中的功能**：
  - 提供精细的配额使用分析
  - 支持按模型、用户、时间等维度统计
  - 为计费和报表提供数据支持
  - 帮助识别使用模式和优化资源
- **关键字段**：
  - `Id/UserId`：记录和用户标识
  - `ModelName/Quota`：模型名称和消耗配额
  - `Date/Time`：使用时间
  - `Type`：使用类型

### 11. Task（任务表）
- **核心作用**：通用异步任务管理
- **在项目中的功能**：
  - 管理长时间运行的任务
  - 支持任务状态跟踪和结果存储
  - 实现任务队列和优先级处理
  - 提供任务重试和错误处理
- **关键字段**：
  - `Id/Type`：任务标识和类型
  - `Status/Progress`：任务状态和进度
  - `UserId/ChannelId`：关联信息
  - `Result/Error`：任务结果和错误信息
  - `CreatedAt/UpdatedAt`：时间戳

这些数据库表共同构成了系统的数据层，支持API网关的各项核心功能，包括用户管理、渠道管理、请求转发、配额控制和日志记录等。表之间通过外键关系形成有机的整体，确保数据的一致性和完整性。

## 数据库类型及其使用场景

系统支持三种不同类型的数据库，根据不同的部署需求和规模可以灵活选择：

### 1. SQLite
- **使用场景**：默认数据库选项，适用于以下情况：
  - 开发环境和测试环境
  - 小型部署和个人使用
  - 不需要高并发访问的场景
  - 资源有限的服务器环境
- **配置方式**：
  - 无需特殊配置，当`SQL_DSN`环境变量未设置或设置为`local`时自动使用
  - 数据存储在本地文件中，默认路径为`data/one-api.db`
- **特点**：
  - 零配置，开箱即用
  - 单文件数据库，便于备份和迁移
  - 无需额外数据库服务器
  - 适合轻量级应用

### 2. MySQL
- **使用场景**：适用于以下情况：
  - 生产环境部署
  - 中等规模的用户群体
  - 需要较高并发处理能力
  - 需要更好性能和可扩展性的场景
- **配置方式**：
  - 通过设置`SQL_DSN`环境变量指向MySQL连接字符串
  - 例如：`SQL_DSN=user:password@tcp(localhost:3306)/one-api?charset=utf8mb4&parseTime=True&loc=Local`
- **特点**：
  - 良好的性能和稳定性
  - 支持高并发访问
  - 广泛的社区支持和工具生态
  - 可靠的事务处理

### 3. PostgreSQL
- **使用场景**：适用于以下情况：
  - 企业级生产环境
  - 大规模部署和高负载场景
  - 需要高级数据库功能的场景
  - 对数据完整性要求极高的应用
- **配置方式**：
  - 通过设置`SQL_DSN`环境变量指向PostgreSQL连接字符串
  - 例如：`SQL_DSN=postgres://user:password@localhost:5432/one-api`
- **特点**：
  - 强大的企业级特性
  - 优秀的大数据处理能力
  - 先进的查询优化器
  - 完善的数据完整性保障

### 日志数据库分离

系统支持将日志数据与核心业务数据分离存储：

- **配置方式**：通过设置`LOG_SQL_DSN`环境变量
- **使用场景**：
  - 高流量生产环境，日志数据量大
  - 需要独立管理和备份日志数据
  - 希望避免日志写入影响核心业务性能
- **特点**：
  - 如果未设置`LOG_SQL_DSN`，日志将存储在主数据库中
  - 日志数据库可以使用与主数据库不同的数据库类型
  - 日志数据库仅存储`Log`表数据

所有这三种数据库类型都存储相同的数据结构和表，选择哪种数据库主要取决于部署规模、性能需求和运维偏好。系统会根据配置的连接字符串自动选择适当的数据库驱动和配置。

## 扩展性设计

系统设计了良好的扩展机制：

1. **适配器模式**：通过适配器支持不同的AI服务提供商
2. **中间件链**：可插拔的中间件架构
3. **模型映射**：灵活的模型名称映射机制
4. **分组管理**：通过分组实现多租户隔离

## 安全性考虑

系统实现了多层次的安全保障：

1. **认证机制**：多种认证方式结合
2. **IP限制**：支持IP白名单
3. **配额控制**：防止资源滥用
4. **敏感词过滤**：可选的内容审核
5. **错误处理**：安全的错误信息返回